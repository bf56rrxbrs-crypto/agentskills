name: PR Review and Quality Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd skills-ref
          pip install -e .
          pip install pytest ruff

      - name: Run linting
        run: |
          cd skills-ref
          ruff check . --output-format=github
        continue-on-error: true

      - name: Check formatting
        run: |
          cd skills-ref
          ruff format --check .
        continue-on-error: true

      - name: Run tests
        run: |
          cd skills-ref
          pytest -v --tb=short

  conflict-detection:
    name: Conflict Detection
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for merge conflicts
        run: |
          git fetch origin ${{ github.base_ref }}
          if git merge-tree $(git merge-base HEAD origin/${{ github.base_ref }}) HEAD origin/${{ github.base_ref }} | grep -q '<<<<<'; then
            echo "âš ï¸ Merge conflicts detected"
            echo "Please resolve conflicts before merging"
            exit 1
          else
            echo "âœ… No merge conflicts detected"
          fi

  auto-review:
    name: Automated Review
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          cd skills-ref
          pip install -e .
          pip install pytest ruff

      - name: Analyze changes
        id: analyze
        run: |
          echo "Analyzing PR changes..."
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "changed_files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Count changes
          TOTAL_FILES=$(echo "$CHANGED_FILES" | wc -l)
          echo "total_files=$TOTAL_FILES" >> $GITHUB_OUTPUT
          
          # Check if skills-ref code changed
          if echo "$CHANGED_FILES" | grep -q "skills-ref/src/"; then
            echo "code_changed=true" >> $GITHUB_OUTPUT
          else
            echo "code_changed=false" >> $GITHUB_OUTPUT
          fi
          
          # Check if tests changed
          if echo "$CHANGED_FILES" | grep -q "skills-ref/tests/"; then
            echo "tests_changed=true" >> $GITHUB_OUTPUT
          else
            echo "tests_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate review summary
        run: |
          echo "## ðŸ¤– Automated PR Review Summary" > review-summary.md
          echo "" >> review-summary.md
          echo "### Changes Overview" >> review-summary.md
          echo "- **Files changed:** ${{ steps.analyze.outputs.total_files }}" >> review-summary.md
          echo "- **Code modified:** ${{ steps.analyze.outputs.code_changed }}" >> review-summary.md
          echo "- **Tests modified:** ${{ steps.analyze.outputs.tests_changed }}" >> review-summary.md
          echo "" >> review-summary.md
          
          # Run quality checks
          cd skills-ref
          
          echo "### Code Quality" >> ../review-summary.md
          if ruff check . --quiet; then
            echo "âœ… Linting: No issues found" >> ../review-summary.md
          else
            echo "âš ï¸ Linting: Issues detected (see details above)" >> ../review-summary.md
          fi
          
          if ruff format --check . --quiet; then
            echo "âœ… Formatting: Properly formatted" >> ../review-summary.md
          else
            echo "âš ï¸ Formatting: Needs formatting (run \`ruff format .\`)" >> ../review-summary.md
          fi
          
          echo "" >> ../review-summary.md
          echo "### Test Results" >> ../review-summary.md
          if pytest --quiet; then
            echo "âœ… All tests passing" >> ../review-summary.md
          else
            echo "âŒ Test failures detected" >> ../review-summary.md
          fi
          
          cd ..
          cat review-summary.md

      - name: Post review comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('review-summary.md', 'utf8');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: summary
            });

  security-check:
    name: Security Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run security audit
        run: |
          cd skills-ref
          pip install safety
          safety check --json || true
        continue-on-error: true
